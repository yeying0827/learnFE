## å°†é•œåƒä¸Šä¼ è‡³ç§æœ‰é•œåƒåº“ï¼šè®©é•œåƒç®¡ç†æ›´ç§å¯†

### ä»€ä¹ˆæ˜¯é•œåƒåº“

é•œåƒåº“å°±æ˜¯é›†ä¸­å­˜æ”¾é•œåƒçš„ä¸€ä¸ªæ–‡ä»¶æœåŠ¡ã€‚é•œåƒåº“åœ¨`CI/CD`ä¸­åˆç§°ä¸º`åˆ¶å“åº“`ã€‚æ„å»ºåçš„äº§ç‰©ç§°ä¸º`åˆ¶å“`ï¼Œåˆ¶å“è¦æ”¾åˆ°`åˆ¶å“åº“`åš`ä¸­è½¬`å’Œ`ç‰ˆæœ¬ç®¡ç†`ã€‚å¸¸ç”¨å¹³å°æœ‰Nexusã€Jfrogã€Harboræˆ–å…¶ä»–å¯¹è±¡å­˜å‚¨å¹³å°ã€‚

æ­¤å¤„é€‰ç”¨`Nexus3`ä½œä¸ºé•œåƒåº“ã€‚å› ä¸ºå…¶ç¨³å®šã€æ€§èƒ½å¥½ã€å…è´¹ã€éƒ¨ç½²æ–¹ä¾¿ï¼Œä¸”æ”¯æŒç±»å‹å¤šï¼Œæ˜¯è®¸å¤šåˆ¶å“åº“çš„é¦–é€‰é€‰å‹ã€‚

### éƒ¨ç½²NexusæœåŠ¡

åœ¨éƒ¨ç½²ä¹‹å‰ï¼Œéœ€è¦å…ˆä¸‹è½½`Nexus`çš„å®‰è£…åŒ…ï¼š

```shell
# ä¸‹è½½
wget https://dependency-fe.oss-cn-beijing.aliyuncs.com/nexus-3.29.0-02-unix.tar.gz
# è§£å‹
tar -zxvf ./nexus-3.29.0-02-unix.tar.gz
```

è§£å‹åå¯ä»¥çœ‹åˆ°2ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«æ˜¯`nexus-3.29.0-02`å’Œ`sonatype-work`ã€‚å…¶ä¸­ï¼Œ`nexus-3.29-02`æ˜¯nexusä¸»ç¨‹åºæ–‡ä»¶å¤¹ï¼Œ`sonatype-work`æ˜¯æ•°æ®æ–‡ä»¶ã€‚

### å¯åŠ¨Nexus

è¿›å…¥`nexus-3.29.0-02`ä¸‹é¢çš„`bin`ç›®å½•ï¼Œå³`nexus`çš„ä¸»å‘½ä»¤ç›®å½•ã€‚åœ¨binç›®å½•ä¸‹æ‰§è¡Œ`./nexus start`å‘½ä»¤å³å¯å¯åŠ¨`nexus`ã€‚

```shell
[yy@localhost bin]$ ./nexus start
```

> nexusä¹Ÿæ”¯æŒåœæ­¢ã€é‡å¯ç­‰å‘½ä»¤ã€‚å¯ä»¥åœ¨binç›®å½•ä¸‹æ‰§è¡Œ`./nexus help`æŸ¥çœ‹æ›´å¤šå‘½ä»¤ã€‚

ç”±äº`nexus`é»˜è®¤æœåŠ¡ç«¯å£æ˜¯`8081`ï¼Œç¨åè¿˜éœ€è¦ç»™é•œåƒåº“è®¿é—®å•ç‹¬å¼€æ”¾ä¸€ä¸ª`8082`ç«¯å£ã€‚è¿™é‡Œå°†`8081`ï¼Œ`8082`ç«¯å£æ·»åŠ åˆ°é˜²ç«å¢™æ”¾è¡Œè§„åˆ™å†…ï¼š

```shell
sudo firewall-cmd --zone=public --add-port=8081/tcp --permanent
sudo firewall-cmd --zone=public --add-port=8082/tcp --permanent
```

è®¿é—®`IP:8081`ã€‚nexuså¯åŠ¨æ—¶é—´æ¯”è¾ƒé•¿ï¼Œéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ã€‚

[nexus é»˜è®¤æ²¡æœ‰é…ç½®javaè·¯å¾„ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®](https://blog.csdn.net/u011590297/article/details/108590263)

```shell
# nexus é»˜è®¤æ²¡æœ‰é…ç½®javaè·¯å¾„ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®
cd  ä½ çš„nexuså®‰è£…è·¯å¾„/bin
vi nexus
# ä¸º INSTALL4J_JAVA_PREFIX  è®¾ç½®java ç¯å¢ƒåœ°å€
# ...
INSTALL4J_JAVA_PREFIX="$JAVA_HOME" # é»˜è®¤INSTALL4J_JAVA_PREFIX=""
# ...
```

[nexuså¯åŠ¨æŠ¥é”™ï¼š Error occurred while executing a write operation to database 'OSystem' due to limited free space on the disk (2378 MB). The databa se is now working in read-only mode. Please close the database (or stop OrientDB), make room on you r hard drive and then reopen the database. ](https://blog.csdn.net/java_998/article/details/124298006)

```shell
cd ä½ çš„nexuså®‰è£…è·¯å¾„/bin
vi nexus.vmoptions
# æ·»åŠ -Dstorage.diskCache.diskFreeSpaceLimit=1024
```

å¯åŠ¨nexusæˆåŠŸä½†æ˜¯æ— æ³•è®¿é—®ï¼Œé‡å¯é˜²ç«å¢™ï¼š

```shell
systemctl reload firewalld
```

åœ¨`Nexus`å¯åŠ¨åï¼Œä¼šè¿›å…¥ä¸‹é¢è¿™ä¸ªæ¬¢è¿é¡µé¢ã€‚

<img src="../nexus-firstvisit.png" alt="first visit" style="zoom:50%;" />

### é…ç½®Nexus

ç‚¹å‡»å³ä¸Šè§’çš„sign inï¼Œæ‰“å¼€ç™»å½•æ¡†ã€‚è¾“å…¥`é»˜è®¤ç®¡ç†å‘˜å¯†ç `è¿›è¡Œåˆå§‹åŒ–é…ç½®ã€‚

<img src="../signin-nexus.png" alt="signin nexus" style="zoom:50%;" />

```shell
# åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°å¯†ç ï¼Œç™»å½•åæ˜¯admin
[yy@localhost bin]$ cat /home/yy/sonatype-work/nexus3/admin.password
```

ç™»å½•åè¿›å…¥é…ç½®ï¼š

1. è®¾ç½®æ–°å¯†ç  123456

2. è®¾ç½®æ˜¯å¦å¼€å¯åŒ¿åè®¿é—®ã€‚

   åŒ¿åè®¿é—®å¯ä»¥åœ¨æ²¡æœ‰ç™»å½•çš„æƒ…å†µä¸‹æ‹‰å–ï¼ˆæ¨é€ï¼‰åˆ¶å“åˆ°åˆ¶å“åº“ï¼Œä¾¿æ·ä½†æ˜¯ä¸ªå±é™©è¡Œä¸ºã€‚

   å¦‚ï¼Œè¿™ä¸ªåˆ¶å“åº“ä¹Ÿæ”¯æŒ`node`çš„`npm`ç§æœ‰åº“ã€‚é‚£ä¹ˆåœ¨æ²¡æœ‰`npm login`ç™»å½•è¿™ä¸ªåˆ¶å“åº“ä¹‹å‰ï¼Œå°±å¯ä»¥è¿›è¡Œ`npm install`ã€`npm publish`ï¼Œå…¶å®æ˜¯ä¸å¤ªå®‰å…¨çš„ã€‚ä»»ä½•ä¸€ä¸ªçŸ¥é“åˆ¶å“åº“åœ°å€çš„äººï¼Œéƒ½å¯ä»¥ä»»æ„è¿›è¡Œæ¨é€å’Œè·å–èµ„æºã€‚

   è¿™é‡Œä¸ºäº†æµ‹è¯•ï¼Œå…ˆå¼€å¯åŒ¿åè®¿é—®

### åˆ›å»ºä¸€ä¸ªDockerç§æœ

é…ç½®å®Œæˆåï¼Œç‚¹å‡»é¡¶éƒ¨å¯¼èˆªæ çš„`é½¿è½®`å›¾æ ‡è¿›å…¥é…ç½®é¡µ=>ç‚¹å‡»å·¦ä¾§èœå•ä¸­çš„`Repositories`=>ç‚¹å‡»`Create repository`

<img src="../create-repository.png" alt="create repository" style="zoom:50%;" />

ç‚¹å‡»åä¼šè¿›å…¥ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™æ˜¯`Nexus`æ‰€æ”¯æŒçš„åˆ¶å“åº“ç±»å‹ã€‚å…¶ä¸­æœ‰`docker`ï¼Œä¹Ÿæœ‰`npm`ç­‰ç­‰ã€‚

<img src="../select-recipe.png" alt="select recipe" style="zoom:50%;" />

#### 1. åˆ›å»ºåˆ¶å“åº“

åœ¨`nexus`ä¸­ï¼Œåˆ¶å“åº“ä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š

* proxy

  æ­¤ç±»å‹åˆ¶å“åº“åŸåˆ™ä¸Š**åªä¸‹è½½ï¼Œä¸å…è®¸ç”¨æˆ·æ¨é€**ã€‚å¯ä»¥ç†è§£ä¸º**ç¼“å­˜å¤–ç½‘åˆ¶å“çš„åˆ¶å“åº“**ã€‚

  ä¾‹å¦‚ï¼šåœ¨æ‹‰å–`nginx`é•œåƒæ—¶ï¼Œå¦‚æœé€šè¿‡`proxy`ç±»å‹çš„åˆ¶å“åº“ï¼Œåˆ™å®ƒä¼šå»åˆ›å»ºæ—¶é…ç½®å¥½çš„å¤–ç½‘`docker`é•œåƒæºæ‹‰å–ï¼ˆç±»ä¼¼`cnpm`ï¼‰åˆ°è‡ªå·±çš„åˆ¶å“åº“ï¼Œç„¶åç»™ä½ ï¼›ç¬¬äºŒæ¬¡æ‹‰å–ï¼Œåˆ™ä¸ä¼šä»å¤–ç½‘ä¸‹è½½ã€‚èµ·åˆ°`å†…ç½‘ç¼“å­˜`çš„ä½œç”¨ã€‚

* hosted

  æ­¤ç±»å‹å’Œ`proxy`ç›¸åï¼ŒåŸåˆ™ä¸Š**åªå…è®¸ç”¨æˆ·æ¨é€ï¼Œä¸å…è®¸ç¼“å­˜**ã€‚è¿™é‡Œåªå­˜æ”¾è‡ªå·±çš„ç§æœ‰é•œåƒæˆ–åˆ¶å“ã€‚

* group

  æ­¤ç±»å‹å¯ä»¥å°†ä»¥ä¸Šä¸¤ç§ç±»å‹çš„åˆ¶å“åº“ç»„åˆèµ·æ¥ã€‚ç»„åˆååªè®¿é—®`group`ç±»å‹åˆ¶å“åº“ï¼Œå°±éƒ½å¯ä»¥è®¿é—®ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸éœ€è¦**ç¼“å­˜å¤–ç½‘é•œåƒ**ï¼Œé€‰æ‹©`docker(hosted)`å³å¯ã€‚

ç»§ç»­è¿›è¡Œå…¶ä»–é…ç½®ï¼šå°†ä¹‹å‰é¢„ç•™çš„`8082`ç«¯å£å¡«å…¥`HTTP`è¾“å…¥æ¡†ã€æš‚æ—¶å…è®¸åŒ¿åæ‹‰å–é•œåƒã€å¹¶åšå…¼å®¹é…ç½®ã€‚

<img src="../docker-repository-setting.png" alt="docker repository setting" style="zoom:50%;" />

æœ€åç‚¹å‡»ä¸‹æ–¹çš„`Create repository`ä¿å­˜å°±åˆ›å»ºæˆåŠŸäº†ã€‚

#### 2. ç»™é•œåƒåº“æ·»åŠ è®¿é—®æƒé™

åˆ›å»ºå¥½é•œåƒåº“åï¼Œè¿˜éœ€è¦é…ç½®è®¿é—®æƒé™æ‰å¯ä»¥ç”¨ã€‚

åœ¨é…ç½®é¡µï¼Œé€‰æ‹©å·¦ä¾§èœå•ä¸­çš„`Realms`ã€‚åœ¨å³è¾¹æ‰¾åˆ°`Docker Bearer Token Realm`ï¼Œå°†å…¶æ·»åŠ åˆ°`Active`å†…ï¼Œä¿å­˜å³å¯ã€‚

<img src="../save-realm.png" alt="save realm" style="zoom:50%;" />

#### 3. æŸ¥çœ‹è·å–é•œåƒåº“åœ°å€

åœ¨repositoriesåˆ—è¡¨ä¸­æ‰¾åˆ°åˆšåˆšåˆ›å»ºçš„åˆ¶å“åº“ï¼Œç‚¹å‡»ä¸Šé¢çš„`copy`æŒ‰é’®ï¼Œå°±å¯ä»¥çœ‹åˆ°é•œåƒåº“åœ°å€ã€‚



### ç™»å½•åˆ¶å“åº“

ç§æœå»ºè®¾å®Œæˆåï¼Œå¦‚æœç§æœå¯¹å¤–è®¿é—®åœ°å€ä¸ºHTTPçš„è¯ï¼Œè¿˜éœ€è¦åœ¨æœåŠ¡å™¨é…ç½®ä¸€ä¸‹æ‰å¯ä»¥ä½¿ç”¨ï¼ˆHTTPSä¸éœ€è¦é…ç½®ï¼‰ã€‚

æ‰¾åˆ°`daemon.json`æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æè¿°äº†å½“å‰`docker`é…ç½®çš„é•œåƒåŠ é€Ÿåœ°å€ï¼Œå’Œé…ç½®è¿‡çš„ç§æœåœ°å€ã€‚

```shell
sudo vi /etc/docker/daemon.json
```

æ‰¾åˆ°`insecure-registries`å­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨å°±æ·»åŠ ä¸€ä¸ªã€‚å€¼æ˜¯æ•°ç»„ç±»å‹ï¼Œå°†ä½ çš„åˆ¶å“åº“åœ°å€å¡«å†™ä¸Šå»ã€‚

```json
{
  "registry-mirrors": ["https://8qw0m0z3.mirror.aliyuncs.com"],
  "insecure-registries": ["10.211.55.6:8082"]
}
```

ä¿å­˜å¹¶é€€å‡ºï¼Œé‡å¯Dockerã€‚

```shell
[yy@localhost docker]$ systemctl restart docker
```

æ¥ç€ä½¿ç”¨`docker login`å‘½ä»¤å°è¯•ç™»å½•ï¼š

`docker login æœåŠ¡IP:ç«¯å£`

<img src="../login-docker.png" alt="login dokcer" style="zoom:50%;" />

### æ¨é€é•œåƒåˆ°åˆ¶å“åº“

å®Œæˆé•œåƒåº“é…ç½®åï¼Œå°±å¯ä»¥ä½¿ç”¨jenkinsæ¨é€è‡ªå·±çš„é•œåƒåˆ°é•œåƒåº“äº†ã€‚

åœ¨Jenkinsä»»åŠ¡çš„è®¾ç½®Shellçš„ç¼–è¾‘æ¡†ï¼Œæ·»åŠ ä¸€æ¡æ¨é€é•œåƒçš„å‘½ä»¤è¿›å»ï¼š

```shell
#!/bin/sh -l

# ...
docker build -t jenkins-test .
docker push jenkins-test
```

> æ³¨ï¼š`docker`åœ¨æ¨é€ä¸€ä¸ªé•œåƒæ—¶ï¼Œ**é•œåƒçš„Tagï¼ˆåç§°:ç‰ˆæœ¬å·ï¼‰å¼€å¤´å¿…é¡»å¸¦ç€é•œåƒåº“çš„åœ°å€ï¼Œæ‰å¯ä»¥æ¨é€åˆ°æŒ‡å®šçš„é•œåƒåº“**ã€‚å¦‚`jenkins-test`æ˜¯ä¸èƒ½æ¨é€åˆ°é•œåƒåº“çš„ï¼Œè€Œ`10.211.55.6:8082/jenkins-test`åˆ™å¯ä»¥æ¨é€åˆ°é•œåƒåº“ã€‚

ä¿®æ”¹shell

```shell
#!/bin/sh -l

# ...
docker build -t 10.211.55.6:8082/jenkins-test .
docker push 10.211.55.6:8082/jenkins-test
```

å°†æ„å»ºçš„é•œåƒåç§°åŠ äº†é•œåƒåº“çš„å‰ç¼€ï¼Œæ¨é€é•œåƒä¹Ÿæ˜¯ä¸€æ ·ï¼Œè¿™æ ·æ‰å¯ä»¥å°†é•œåƒæ¨é€åˆ°æŒ‡å®šé•œåƒåº“ï¼Œä¿å­˜åé‡æ–°æ„å»ºä¸€æ¬¡ã€‚

æ„å»ºåæç¤ºæŠ¥é”™æ²¡æœ‰æƒé™æ¨é€ï¼š

<img src="../docker-no-auth.png" alt="docker no auth" style="zoom:50%;" />

#### åˆ©ç”¨å‡­æ®ç»™Shellæ³¨å…¥é•œåƒåº“ç”¨æˆ·å

æ²¡æœ‰æƒé™ï¼Œå¯ä»¥ä½¿ç”¨`docker login`åœ¨`shell`è„šæœ¬é‡Œé¢ç™»å½•ã€‚ç›´æ¥åœ¨å‘½ä»¤é‡Œå†™å…¥ç”¨æˆ·åå’Œå¯†ç ï¼š

```shell
docker login -u "admin" -p "123456" 10.211.55.6:8082
```

è¿™æ ·åœ¨å‘½ä»¤ä¸­å†™æ­»ï¼Œæ— è®ºå®‰å…¨è¿˜æ˜¯å‹å¥½æ€§ä¸Šï¼Œéƒ½ä¸å¤ªåˆé€‚ï¼›å¯ä»¥å€ŸåŠ©Jenkinsçš„å‡­æ®åŠŸèƒ½ï¼Œæ·»åŠ ä¸€æ¡ç”¨æˆ·åå¯†ç å‡­æ®ï¼Œç„¶ååˆ©ç”¨Shellå˜é‡å†™å…¥åœ¨ç»ˆç«¯å†…ã€‚

æ‰¾åˆ°ä»»åŠ¡çš„è®¾ç½®ç•Œé¢=>æ„å»ºç¯å¢ƒ=>å‹¾é€‰Use secret text(s) or file(s)=>ç‚¹å‡»ä¸‹é¢çš„æ–°å¢æŒ‰é’®ï¼Œé€‰æ‹©`Username and password(seperated)`ã€‚ç‚¹å‡»æ·»åŠ æŒ‰é’®æ¥æ·»åŠ ä¸€æ¡å‡­è¯ã€‚

<img src="../add-docker-credential.png" alt="add docker credential" style="zoom:50%;" />

æ¥ç€åœ¨shellä¸­æ·»åŠ `docker login`å‘½ä»¤ï¼Œå°†æˆ‘ä»¬ä¿å­˜çš„ç”¨æˆ·åå’Œå¯†ç å˜é‡å¡«å†™è¿›å»ï¼š

`docker login -u $DOCKER_LOGIN_USERNAME -p $DOCKER_LOGIN_PASSWORD 10.211.55.6:8082`

ä¿å­˜åå†æ¬¡æ„å»ºï¼Œæ„å»ºæˆåŠŸå¹¶ä¸”æ¨é€æˆåŠŸ

<img src="../push-image-success.png" alt="push image success" style="zoom:50%;" />



### å¦‚ä½•æ¨é€å·²æœ‰çš„é•œåƒåˆ°ä»“åº“ï¼Ÿ

é¢å¯¹load/pullè¿›æ¥çš„é•œåƒï¼Œè¦å¦‚ä½•æ¨é€åˆ°è‡ªå·±çš„é•œåƒåº“å‘¢ï¼Ÿ

å¯ä»¥ä½¿ç”¨`docker tag`å‘½ä»¤ç»™å·²æœ‰çš„é•œåƒæ‰“ä¸ªæ ‡ç­¾ã€‚åœ¨æ‰“æ–°tagæ—¶å¯ä»¥åœ¨tagå¤´éƒ¨åŠ å…¥é•œåƒåº“åœ°å€ã€‚

ğŸŒ°ï¼š

```shell
# docker tag <é•œåƒID>/<é•œåƒåç§°> æ–°é•œåƒåç§°[:ç‰ˆæœ¬]
docker tag 46d1a3ebf53b 10.211.55.6:8082/local/jenkins
```

> æŸ¥çœ‹æœåŠ¡å™¨ä¸Šçš„dockerä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨`docker images`å‘½ä»¤æŸ¥çœ‹

è¿™æ ·å°±å¯ä»¥é‡æ–°æ‰“ä¸€ä¸ªå…¨æ–°çš„tagï¼Œå®ç°`é‡å‘½å`åŠŸèƒ½ã€‚

æ¥ç€ä½¿ç”¨`docker push`å‘½ä»¤å°±å¯ä»¥è¿›è¡Œæ¨é€äº†ã€‚

```shell
docker push 10.211.55.6:8082/local/jenkins
```

**æ“ä½œç»“æœ**

```shell
[yy@localhost ~]$ docker images
REPOSITORY                      TAG           IMAGE ID       CREATED       SIZE
10.211.55.6:8082/jenkins-test   latest        46d1a3ebf53b   3 days ago    16.8MB
jenkins-test                    latest        46d1a3ebf53b   3 days ago    16.8MB
node                            latest        7e9550136fca   11 days ago   998MB
nginx                           1.15-alpine   dd025cdfe837   3 years ago   16.1MB
[yy@localhost ~]$ docker tag 46d1a3ebf53b 10.211.55.6:8082/local/jenkins

[yy@localhost ~]$ sudo docker push 10.211.55.6:8082/local/jenkins
[sudo] password for yy: 
Using default tag: latest
The push refers to repository [10.211.55.6:8082/local/jenkins]
6cea442c9288: Layer already exists 
932d313420f5: Layer already exists 
a521e1bbddf5: Layer already exists 
bf381a670956: Layer already exists 
a61993362baf: Layer already exists 
f1b5933fe4b5: Layer already exists 
latest: digest: sha256:3caee8bc145fc0fececa6e280f1bb0687e0dfd71d194e76ebf3333145b385691 size: 1570
[yy@localhost ~]$ docker images
REPOSITORY                       TAG           IMAGE ID       CREATED       SIZE
10.211.55.6:8082/jenkins-test    latest        46d1a3ebf53b   3 days ago    16.8MB
10.211.55.6:8082/local/jenkins   latest        46d1a3ebf53b   3 days ago    16.8MB
jenkins-test                     latest        46d1a3ebf53b   3 days ago    16.8MB
node                             latest        7e9550136fca   11 days ago   998MB
nginx                            1.15-alpine   dd025cdfe837   3 years ago   16.1MB
```

