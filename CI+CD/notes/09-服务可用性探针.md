## æœåŠ¡å¯ç”¨æ€§æ¢é’ˆï¼šå¦‚ä½•åˆ¤æ–­ä½ çš„æœåŠ¡æ˜¯å¦å¯ç”¨

`kubernetes`ä»¥ä»€ä¹ˆä¾æ®ï¼Œåˆ¤æ–­`Pod`å¯åŠ¨æˆåŠŸï¼Ÿ

### 1. ä»€ä¹ˆæ˜¯å¥åº·åº¦æ£€æŸ¥ï¼Ÿ

ä¹‹å‰çš„éƒ¨ç½²ä¸­ï¼Œå½“`Pod`çš„çŠ¶æ€ä¸º`Running`æ—¶ï¼Œè¯¥`Pod`å°±å¯ä»¥è¢«åˆ†é…æµé‡ï¼ˆå¯ä»¥è®¿é—®åˆ°ï¼‰äº†ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ£€æŸ¥æ–¹å¼å¯¹äºä¸€éƒ¨åˆ†Podæ¥è¯´æ˜¯ä¸é è°±çš„ã€‚

ä¸€èˆ¬ä¸€ä¸ªåç«¯å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œä¸ä¸€å®šä»£è¡¨æœåŠ¡å¯åŠ¨æˆåŠŸï¼›åœ¨åç«¯å®¹å™¨å¯åŠ¨åï¼Œéƒ¨åˆ†SQLã€æ¶ˆæ¯é˜Ÿåˆ—ã€é…ç½®æ–‡ä»¶ç­‰å…¶ä»–æœåŠ¡çš„è¿æ¥è¿˜åœ¨åˆå§‹åŒ–ï¼Œä½†æ˜¯å®¹å™¨çš„å¤–éƒ¨çŠ¶æ€å´æ˜¯å¯åŠ¨æˆåŠŸã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥å»è®¿é—®Podå¿…ç„¶ä¼šæœ‰é—®é¢˜ã€‚

æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è‡ªå·±æ§åˆ¶æµé‡åˆ†é…çš„æ ‡å‡†å‘¢ï¼Ÿ



### 2. ä»€ä¹ˆæ˜¯æœåŠ¡æ¢é’ˆï¼Ÿ

æ¢é’ˆä¸€è¯ï¼Œå’Œå¤ä»£é“¶é’ˆè¯•æ¯’çš„æ¦‚å¿µå·®ä¸å¤šã€‚

åœ¨`kubernetes`ä¸­ï¼Œæ¢é’ˆç”¨æ¥æ£€æµ‹`Pod`çš„å¯ç”¨æƒ…å†µã€‚åœ¨`kubernetes`ä¸­ï¼Œæœ‰ä¸‰ç§æ¢é’ˆå¯ä»¥ä½¿ç”¨ï¼š

#### 2.1 å­˜æ´»æ¢é’ˆ livenessProbe

å­˜æ´»æ¢é’ˆæ˜¯å¯¹è¿è¡Œä¸­çš„å®¹å™¨æ£€æµ‹çš„ï¼›å¦‚æœæƒ³æ£€æµ‹ä½ çš„æœåŠ¡åœ¨è¿è¡Œä¸­æœ‰æ²¡æœ‰å‘ç”Ÿå´©æºƒï¼ŒæœåŠ¡æœ‰æ²¡æœ‰ä¸­é€”é€€å‡ºæˆ–æ— å“åº”ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¢é’ˆã€‚

å¦‚æœæ¢é’ˆæ¢æµ‹åˆ°é”™è¯¯ï¼Œ`Kubernetes`å°±ä¼šæ€æ‰è¿™ä¸ª`Pod`ï¼›å¦åˆ™å°±ä¸ä¼šè¿›è¡Œå¤„ç†ã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸ªæ¢é’ˆï¼Œ`Pod`ä¸ä¼šè¢«æ€æ­»ã€‚

#### 2.2 å¯ç”¨æ¢é’ˆ readinessProbe

ä½œç”¨æ˜¯ç”¨æ¥æ£€æµ‹Podæ˜¯å¦å…è®¸è¢«è®¿é—®åˆ°ï¼ˆæ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡ï¼‰ï¼›å¦‚æœä½ çš„æœåŠ¡åŠ è½½å¾ˆå¤šæ•°æ®ï¼Œæˆ–è€…æœ‰å…¶ä»–éœ€æ±‚è¦æ±‚åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¸è¢«åˆ†é…åˆ°æµé‡ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¢é’ˆã€‚

å¦‚æœæ¢é’ˆæ£€æµ‹å¤±è´¥ï¼Œæµé‡å°±ä¸ä¼šåˆ†é…ç»™è¯¥Podã€‚åœ¨æ²¡æœ‰é…ç½®è¯¥æ¢é’ˆçš„æƒ…å†µä¸‹ï¼Œä¼šä¸€ç›´å°†æµé‡åˆ†é…ç»™Podã€‚

#### 2.3 å¯åŠ¨æ¢é’ˆstartupProbe

ä½œç”¨æ˜¯ç”¨æ¥æ£€æµ‹Podæ˜¯å¦å·²ç»å¯åŠ¨æˆåŠŸï¼›å¦‚æœä½ çš„æœåŠ¡å¯åŠ¨éœ€è¦ä¸€äº›åŠ è½½æ—¶é•¿ï¼ˆå¦‚åˆå§‹åŒ–æ—¥å¿—ã€ç­‰å¾…å…¶ä»–è°ƒç”¨çš„æœåŠ¡å¯åŠ¨æˆåŠŸï¼‰æ‰ä»£è¡¨æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œåˆ™å¯ä»¥ç”¨è¿™ä¸ªæ¢é’ˆã€‚

å¦‚æœæ¢é’ˆæ£€æµ‹å¤±è´¥ï¼Œè¯¥Podå°±ä¼šè¢«æ€æ­»é‡å¯ã€‚åœ¨æ²¡æœ‰é…ç½®è¯¥æ¢é’ˆçš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¸ä¼šæ€æ­»`Pod`ã€‚

åœ¨å¯åŠ¨æ¢é’ˆè¿è¡Œæ—¶ï¼Œå…¶ä»–æ‰€æœ‰çš„æ¢é’ˆæ£€æµ‹éƒ½ä¼šå¤±æ•ˆã€‚

#### 2.4 å¯¹æ¯”ä¸‰ç§ç±»å‹æ¢é’ˆ

`Kubernetes`å†…ç½®äº†ä¸‰ç§å¥åº·åº¦æ¢é’ˆï¼Œå¯ä»¥åˆ†åˆ«åœ¨å¯åŠ¨æ—¶å’Œè¿è¡Œæ—¶ä¸ºæˆ‘ä»¬çš„Podåšæ£€æµ‹ã€‚

å¯¹æ¯”è¡¨æ ¼ï¼š

| æ¢é’ˆåç§° | åœ¨å“ªä¸ªç¯èŠ‚è§¦å‘ | ä½œç”¨                               | æ£€æµ‹å¤±è´¥å¯¹Podçš„ååº”               |
| -------- | -------------- | ---------------------------------- | --------------------------------- |
| å­˜æ´»æ¢é’ˆ | Podè¿è¡Œæ—¶      | æ£€æµ‹æœåŠ¡æ˜¯å¦å´©æºƒï¼Œæ˜¯å¦éœ€è¦é‡å¯æœåŠ¡ | æ€æ­»Podå¹¶é‡å¯                     |
| å¯ç”¨æ¢é’ˆ | Podè¿è¡Œæ—¶      | æ£€æµ‹æœåŠ¡æ˜¯ä¸æ˜¯å…è®¸è¢«è®¿é—®åˆ°         | åœæ­¢Podçš„è®¿é—®è°ƒåº¦ï¼Œä¸ä¼šè¢«æ€æ­»é‡å¯ |
| å¯åŠ¨æ¢é’ˆ | Podè¿è¡Œæ—¶ï¼Ÿ    | æ£€æµ‹æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ               | æ€æ­»Podå¹¶é‡å¯                     |

é…ç½®æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨`containers.livenessProbe/readinessProbe/startupProbe`ä¸‹é…ç½®å³å¯



### 3. ä¸‰ç§æ¢æµ‹æ–¹å¼

è™½ç„¶æ¢é’ˆç±»å‹ä¸åŒï¼Œè§¦å‘çš„é˜¶æ®µä¸åŒï¼Œä½†æ˜¯æ¢æµ‹æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ£€æµ‹çš„APIä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

#### 3.1 ExecAction

è¿™ç§æ–¹å¼æ˜¯åœ¨Podçš„å®¹å™¨å†…æ‰§è¡Œé¢„å®šçš„shellè„šæœ¬å‘½ä»¤ã€‚å¦‚æœæ‰§è¡Œçš„å‘½ä»¤æ²¡æœ‰æŠ¥é”™é€€å‡ºï¼ˆè¿”å›å€¼ä¸º0ï¼‰ï¼Œä»£è¡¨å®¹å™¨çŠ¶æ€å¥åº·ï¼›å¦åˆ™å°±æ˜¯æœ‰é—®é¢˜çš„ã€‚

ğŸŒ°ï¼šä¸€ä¸ªåˆ›å»ºPodçš„é…ç½®æ–‡ä»¶ã€‚é‡Œé¢é…ç½®äº†ä¸€ä¸ªå­˜æ´»æ¢é’ˆlivenessProbe + ExecActionå‘½ä»¤æ£€æµ‹ã€‚å…¶ä¸­ï¼Œ`livenessProbe.exec`ä»£è¡¨å»æ‰§è¡Œä¸€æ®µå‘½ä»¤ï¼Œ`command`åˆ™æ˜¯è¦æ‰§è¡Œçš„æ¢é’ˆå‘½ä»¤ï¼›`livenessProbe`ä»£è¡¨å£°æ˜ä¸€ä¸ªå­˜æ´»æ¢é’ˆã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-exec
spec:
  containers:
  - name: liveness
    image: registry.aliyuncs.com/google_containers/busybox
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
```

Podå¯åŠ¨æˆåŠŸæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œå‘½ä»¤ï¼šæ–°å»ºä¸€ä¸ª`/tmp/healthy`æ–‡ä»¶ => ç¡çœ 30ç§’ => åˆ é™¤`/tmp/healthy` æ–‡ä»¶=> ç¡çœ 600ç§’

```shell
touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
```

æˆ‘ä»¬çš„æ¢é’ˆåœ¨ç¬¬ä¸€æ¬¡ç­‰å¾…5ç§’åæ¢æµ‹ï¼Œä¼šå»å°è¯•è®¿é—®`/tmp/healthy`æ–‡ä»¶æ¥åˆ¤æ–­æ£€æµ‹ç»“æœã€‚ç„¶è€Œï¼Œåªæœ‰åœ¨`Pod`è¿è¡Œçš„å‰30ç§’ï¼Œè¿™ä¸ªæ–‡ä»¶æ‰å­˜åœ¨ï¼›ç¬¬30ç§’ä¹‹åæ–‡ä»¶è¢«åˆ é™¤ï¼Œæ¢é’ˆå°±è®¿é—®ä¸åˆ°è¿™ä¸ªæ–‡ä»¶äº†ï¼Œäºæ˜¯åªå¥½æŒ‰ç…§å¤±è´¥è§„åˆ™é‡å¯`Pod`ã€‚

* æ–°å»ºé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ï¼Œç„¶åæŸ¥çœ‹æ•ˆæœï¼š

```shell
[yy@master probe]$ vim liveness-exec.yaml
[yy@master probe]$ kubectl apply -f liveness-exec.yaml && date && kubectl get pods | grep liveness-exec
pod/liveness-exec created
2022å¹´ 07æœˆ 30æ—¥ æ˜ŸæœŸå…­ 16:33:43 CST
liveness-exec               0/1     ContainerCreating   0          0s
```

* ç­‰å¾…30ç§’åï¼Œé€šè¿‡`kubectl describe`å‘½ä»¤æŸ¥çœ‹Podçš„è¿è¡Œå…¨è§ˆçŠ¶æ€ï¼š

```shell
kubectl describe pods liveness-exec
```

å¯ä»¥çœ‹åˆ°æ‰“å°å‡ºçš„Eventsï¼š

<img src="../liveness-probe-exec.png" alt="livenessprobe exec" style="zoom:50%;" />

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ¢é’ˆæ¢æµ‹å¤±è´¥ï¼ŒPodè¢«è¿«é‡å¯ï¼Œæ¥ç€åˆ›å»ºäº†æ–°çš„Podã€‚

```shell
[yy@master probe]$ kubectl get pod liveness-exec
NAME            READY   STATUS    RESTARTS        AGE
liveness-exec   1/1     Running   367 (55s ago)   2d18h
```

ä¸€æ—¦å¤±è´¥çš„å®¹å™¨æ¢å¤ä¸ºè¿è¡ŒçŠ¶æ€ï¼Œ`RESTARTS` è®¡æ•°å™¨å°±ä¼šå¢åŠ  1

#### 3.2 TCPSocketAction

è¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨TCPå¥—æ¥å­—æ£€æµ‹ã€‚Kubernetesä¼šå°è¯•åœ¨Podå†…ä¸æŒ‡å®šçš„ç«¯å£è¿›è¡Œè¿æ¥ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼ˆPodçš„ç«¯å£æ‰“å¼€äº†ï¼‰ï¼Œå°±ä»£è¡¨è¿™ä¸ªå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸èƒ½ï¼Œåˆ™ä»£è¡¨è¿™ä¸ªPodæ˜¯æœ‰é—®é¢˜çš„ã€‚

ğŸŒ°ï¼šæ–°å»ºä¸€ä¸ªPodé…ç½®æ–‡ä»¶ã€‚å®šä¹‰ä¸€ä¸ªå¯ç”¨æ¢é’ˆ + å­˜æ´»æ¢é’ˆï¼Œæ£€æµ‹æ–¹å¼ä¸ºTCPæ£€æµ‹ã€‚æ¢é’ˆä¼šåœ¨å®¹å™¨å¯åŠ¨æˆåŠŸ5ç§’åå¼€å§‹æ£€æµ‹ï¼Œæ¯10ç§’æ£€æµ‹ä¸€æ¬¡ï¼Œæ¯æ¬¡ä¼šå°è¯•è®¿é—®Podçš„`8080`ç«¯å£ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: tcp-socket-action
  labels:
    app: tcp-socket-action
spec:
  containers:
  - name: tcp-socket-action
    image: registry.cn-hangzhou.aliyuncs.com/janlay/goproxy:0.1
    ports:
    - containerPort: 8080
    readinessProbe:
      tcpSocket:
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10
    livenessProbe:
      tcopSocket:
        port: 8080
      initialDelaySeconds: 15
      periodSeconds: 20
```

* æ–°å»ºé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ï¼Œç„¶åæŸ¥çœ‹æ•ˆæœï¼š

```shell
[yy@master probe]$ vim tcp-socket-action.yaml
[yy@master probe]$ kubectl apply -f tcp-socket-action.yaml && kubectl get Pods | grep tcp-socket-action
pod/tcp-socket-action created
tcp-socket-action           0/1     ContainerCreating   0                 0s
```

* ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œé€šè¿‡`kubectl describe`å‘½ä»¤æŸ¥çœ‹Podçš„è¿è¡Œå…¨è§ˆçŠ¶æ€ï¼š

```shell
kubectl describe pods tcp-socket-action
```

<img src="../tcp-socket-probe.png" alt="tcp socket probe" style="zoom:50%;" />

å¯ä»¥çœ‹åˆ°ï¼Œæ¢é’ˆæ£€æµ‹æˆåŠŸ

#### 3.3 HTTPGetAction

è¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨HTTP GETè¯·æ±‚æ£€æµ‹ã€‚Kubernetesä¼šå°è¯•è®¿é—®Podå†…æŒ‡å®šçš„APIè·¯å¾„ï¼Œå¦‚æœè¿”å›200ï¼Œä»£è¡¨å®¹å™¨å°±æ˜¯å¥åº·çš„ï¼›å¦‚æœä¸èƒ½ï¼Œä»£è¡¨è¿™ä¸ªPodæ˜¯æœ‰é—®é¢˜çš„ã€‚

ğŸŒ°ï¼šé…ç½®ä¸€ä¸ªå­˜æ´»æ¢é’ˆã€‚æ¢é’ˆå°†ä¼šåœ¨å®¹å™¨å¯åŠ¨æˆåŠŸå3ç§’å¼€å§‹è¿›è¡Œæ£€æµ‹ï¼Œæ¯éš”3ç§’æ£€æµ‹ä¸€æ¬¡ï¼Œæ¯æ¬¡éƒ½ä¼šæºå¸¦`httpHeaders`å†…å¡«å†™çš„è¯·æ±‚å¤´ï¼Œå¹¶å°è¯•è®¿é—®`8080`ç«¯å£ä¸‹çš„`/healthz`åœ°å€ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-http
spec:
  containers:
  - name: liveness
    image: registry.cn-hangzhou.aliyuncs.com/janlay/liveness
    args:
    - /server
    livenessProbe:
      httpGet:
        path: /healthz
        port:8080
        httpHeaders:
        - name: Custom-Header
          value: Awesome
      initialDelaySeconds: 3
      periodSeconds: 3
```

å®¹å™¨å†…`/healthz`åœ°å€çš„ç¼–å†™è§„åˆ™æ˜¯ï¼šå®¹å™¨å¯åŠ¨`10`ç§’é’Ÿå†…ä¼šè¿”å›`200`çŠ¶æ€ç ï¼›ä¹‹åç»Ÿä¸€è¿”å›`500`çŠ¶æ€ç ã€‚

```go
http.HandleFunc("/healthz", func(w http.ResponseWriter, r *http.Request) {
  duration := time.Now().Sub(started)
  if duration.Seconds() > 10 {
    w.WriteHeader(500)
    w.Write([]byte(fmt.Sprintf("error: %v", duration.Seconds())))
  } else {
    w.WriteHeader(200)
    w.Write([]byte("ok"))
  }
})
```

æ¥ç€ä¿å­˜é…ç½®æ–‡ä»¶ï¼Œç­‰å¾…10-20ç§’åæŸ¥çœ‹ç»“æœ

```shell
vim liveness-http.yaml
kubectl apply -f liveness-http.yaml
kubectl describe prods liveness-http # ç­‰10-20ç§’åå†æ‰§è¡Œ
```

å¯ä»¥çœ‹åˆ°ï¼ŒPodå¯åŠ¨ä¸€æ®µæ—¶é—´åï¼Œæ¢é’ˆæ£€æµ‹åˆ°è¿”å›å€¼500åï¼Œæ ‡è®°æ£€æµ‹å¤±è´¥ï¼Œå¹¶å›æ”¶äº†Podé‡æ–°åˆ›å»ºã€‚

```shell
[yy@master probe]$ kubectl get pods | grep liveness-http
liveness-http               1/1     Running            2 (7s ago)        49s
[yy@master probe]$ kubectl get pods | grep liveness-http
liveness-http               0/1     CrashLoopBackOff   3 (7s ago)        85s
```

<img src="../liveness-http.png" alt="liveness http" style="zoom:50%;" />

### 4. æ§åˆ¶æ¢é’ˆæ£€æµ‹çš„è¡Œä¸º

æœ‰ä»€ä¹ˆå‚æ•°å¯ä»¥ä¿®æ”¹æ£€æµ‹è¡Œä¸ºå‘¢ï¼Ÿ

`Kubernetes`ç»™æˆ‘ä»¬å‡†å¤‡äº†ä¸€äº›é¢å¤–çš„å‚æ•°å¸®åŠ©æˆ‘ä»¬æ¥å®šä¹‰æ£€æµ‹è¡Œä¸ºï¼š

* initialDelaySecondsï¼šå®¹å™¨åˆå§‹åŒ–ç­‰å¾…å¤šå°‘ç§’åæ‰ä¼šè§¦å‘æ¢é’ˆï¼Œé»˜è®¤ä¸º0
* periodSecondsï¼šæ‰§è¡Œæ¢æµ‹çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤10ç§’ï¼Œæœ€å°‘1ç§’
* timeoutSecondsï¼šæ¢æµ‹è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤1ç§’ï¼Œæœ€å°‘1ç§’
* successThresholdï¼šæ¢æµ‹å¤±è´¥åçš„æœ€å°è¿æ¥æˆåŠŸæ•°é‡ï¼Œé»˜è®¤æ˜¯1
* failureThresholdï¼šæ¢æµ‹å¤±è´¥åçš„é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯3ï¼Œæœ€å°æ˜¯1

[å‚è€ƒèµ„æ–™](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-TCP-liveness-probe)