## 基础篇：浏览器

`CSS`的一些基础知识与核心原理——>兼容性——>浏览器（`CSS`的运行环境）

### 浏览器

显示万维网媒体信息（文字、图像、音频、视频等）与处理用户交互操作的软件。

浏览器是`Internet`时代的产物，随着各种设备操作系统的普及、网络技术的全球化以及人们对信息需求的爆炸式增长，为浏览器的诞生与兴起气筒了强大动力，同时也标志着互联网时代的到来。

#### 组成

虽然浏览器品牌众多，浏览器的结构一般由以下部分组成：

* 地址栏：用于输入网页地址，通过识别地址信息跳转到相应网页
* 菜单栏：包括设置内容与常见快捷操作，用户可自定义设置内容
* 标签栏：包括一个或多个窗口，窗口内容互不干扰、独立运行
* 窗口栏：用于显示当前网页地址的访问内容，为用户提供各种交互操作
* 状态栏：用于实时显示当前操作与网页下载的进度情况

#### 历史

简单列举一些浏览器的历史时刻：

* 1993年：`NCSA组织`发布`Mosaic浏览器`
* 1994年：`网景公司`发布`Navigator浏览器`
* 1995年：`微软公司`发布`IExplorer浏览器`，同时掀起**浏览器之战**
* 1996年：
  * `Navigator`市场份额达到86%，微软公司开始将`IExplorer`整合到Windows系统中
  * `欧朋公司`发布`Opera浏览器`
* 1998年：`网景公司`启动开源产品，开始推出`Mozilla`
* 2001年：为人诟病的`IExplorer 6`发布，霸占国内市场十多年
* 2002年：`网景公司`发布`Firefox浏览器`
* 2003年：`苹果公司`发布`Safari浏览器`
* 2004年：`IEplorer`市场份额达到历史顶峰92%，自此以后其市场份额开始下滑
* 2006年：`Firefox 3`的发布创下吉尼斯世界纪录，一天**800万**下载量
* 2008年：`谷歌公司`发布`Chrome浏览器`

至此世界五大浏览器鼎力的格局逐渐形成。

世界五大浏览器包括：Chrome、Safari、Firefox、Opera、IExplorer/Edge



### 渲染引擎

又称浏览器内核，指负责对网页语法解析并渲染为一张可视化网页的解析器。

浏览器最核心最重要的部位，不同内核对网页语法的解析也有不同，因此同一网页语法在不同内核的浏览器中的渲染效果也可能不同，这就是**浏览器差异性**。

世界五大浏览器，在自身发展时都使用了一种或多种渲染引擎作为自身的渲染引擎。

* Google Chrome：Webkit（前期）、Blink（后期）
* Apple Safari：Webkit
* Mozilla Firefox：Gecko
* ASA Opera：Presto（前期）、Blink（后期）
* Microsoft IExplorer：Trident
* Microsoft Edge：Trident（前期）、Blink（后期）

世界五大浏览器在所有浏览器产品中占领着巨大的市场份额，因此被大规模使用的渲染引擎也就是那几个浏览器相应的渲染引擎。

* Blink内核：谷歌公司与欧朋公司合作自研的内核，同时谷歌公司也将其作为开源内核架构`Chromium`的一部分发布出来，在`Chrome 28+`与`Opera 15+`中被使用
* Webkit内核：苹果公司自研的内核，也是`Blink`内核的原型，在`Chrome 1~28`和`Safari 1+`中被使用
* Gecko内核：网景公司自研的内核，前期在`Navigator`中使用，后期推广到`Firefox`中，在`Firefox 1+`中被使用
* Presto内核：欧朋公司自研的内核，其渲染性能达到了极致但牺牲了兼容性，目前已废弃，在`Opera 7~14`中被使用
* Trident内核：微软公司自研的内核，在`IExplorer 4+`中被使用

> 小故事：Gecko内核由来
>
> `Gecko内核`的诞生跟`IExplorer`有点关系。早期`IExplorer`不使用`W3C标准`，导致微软公司的一些开发者很不满，他们出走并与网景公司一些开发者共同创办了`Mozilla`，以当时`Mosaic内核`为基础重新开发出`Gecko内核`。

> 小故事：浏览器大战
>
> 微软公司的IExplorer曾经与其他浏览器发生过两次`大战`，因为其垄断性质的操作也导致其在2014年后开始慢慢走向衰落，直至2022年被官方宣布完全放弃。
>
> 第一次发生在`1995年~1998年`，微软公司将IExplorer植入到全世界使用率最高的Windows系统中，相当于买电脑送浏览器，这种操作让IExplorer在极短时间内超过了`Navigator`的市场份额，导致后续与网景公司的`Navigator`大打出手，最后网景公司将`Navigator`卖给AOL公司为收场结束这次浏览器大战。
>
> 第二次发生在`2003年~2022年`，很多后起之秀的浏览器，例如`Safari`、`Firefox`、`Opera`和`Chrome`，还有众多国产浏览器，都积极通过各种技术手段并推出更多用户功能的方式对抗IExplorer的打压，经过十多年的竞争，以`Chrome`为首的浏览器在2018年终于反超IExplorer的市场份额并一步步拉开差距，最终IExplorer在2022年被官方宣布完全放弃。
>
> 一代浏览器之王IExplorer就此落幕。

一个统计互联网市场份额的网站[StatCounter](https://gs.statcounter.com/)，可根据需求查询不同浏览器的统计数据。当产品经理让你兼容某些落后浏览器，可把浏览器市场份额统计数据全盘搬出，大声并自信地告诉他：现在几乎无人使用XX浏览器了。



### 渲染过程

要了解浏览器网页的渲染过程，首先得知道**关键渲染路径**。

关键渲染路径，是指浏览器从最初接收请求的响应得到`HTML`、`CSS`、`JS`等资源，然后解析、构建、渲染、布局、绘制和合成，到最后呈现在用户眼前的整个过程。

将关键渲染路径划分理解，则网页的渲染过程可分为以下部分：

* 解析文件
  * DOM树：将`html`转换为DOM树
  * CSSOM树：将`css`转换为CSSOM树
  * 渲染树：将DOM树与CSSOM树合并生成`渲染树`
* 绘制图层
  * 回流：根据`渲染树`生成`布局渲染树`
  * 重绘：根据`布局渲染树`生成`绘制渲染树`
* 合成图层：根据`绘制渲染树`合成图层显示在屏幕中

#### 解析文件

* HTML

  `HTML文档`描述网页的结构，浏览器通过`HTML解析器`将`HTML`解析为`DOM树结构`。`HTML文档`中所有内容皆为节点，各节点间拥有层级关系，彼此相连，组成`DOM树`。

  构建`DOM树`的过程：

  读取`HTML文档`的字节（Bytes），将字节转换成字符（Chars），根据字符确定标签（Tokens），将标签转换成节点（Nodes），以节点为基准构建**DOM树**。

* CSS

  `CSS文档`描述网页的表现，浏览器通过`CSS解析器`将`CSS`解析为`CSSOM树结构`。`CSS文档`中所有内容皆为节点，与HTML文档中的节点一一相应，各节点间拥有层级关系，彼此相连，组成`CSSOM树`。

  构建`CSSOM树`的过程：

  读取`CSS文档`的字节（Bytes），将字节转换成字符（Chars），根据字符确定标签（Tokens），将标签转换成节点（Nodes），以节点为基准构建`CSSOM树`。与`DOM树`的构建过程完全一样。

在构建`DOM树`时，当`HTML解析器`遇到`<script>`标签时会立即阻塞`DOM树`的构建，将控制权移交给浏览器的`JS引擎`，等到`JS引擎`运行完毕，浏览器才会从中断的地方恢复`DOM树`的构建。

`<script>`的脚本加载完毕，`JS引擎`通过DOM API与CSSOM API操作`DOM树`和`CSSOM树`。为何会产生渲染阻塞？其根本原因在于`JS`操作`DOM`后，浏览器无法预测未来`DOM`的具体内容，为了防止无效操作与节省资源，只能阻塞`DOM树`的构建。

<img src="../imgs/build-render-tree.awebp" alt="build-render-tree" style="zoom:50%;" />

浏览器的渲染引擎将`DOM树`与`CSSOM树`合并生成渲染树，只渲染需显示的节点及其样式。`DOM树`、`CSSOM树`和`渲染树`三者的构建并无`先后条件`与`先后顺序`，非完全独立而是存在交叉并行构建的情况，因此会形成一边加载、一边解析、一边渲染的工作现象。

#### 绘制图层

进入绘制阶段，遍历渲染树，调用渲染器的`paint()`在屏幕中绘制内容。

根据渲染树布局计算样式，即每个节点在网页中的布局、尺寸等几何属性。`HTML`默认是流式布局，`CSS`和`JS`会打破这种布局，改变`DOM`的几何属性与外观属性。

在绘制时根据渲染树布局，再根据布局绘制，这就是**回流重绘**。

* 回流：改变几何属性的渲染
* 重绘：改变外观属性而不影响几何属性的渲染

当生成渲染树后，至少会渲染一次，在后续交互时还会不断地重新渲染。这时`只会回流重绘`或`只有重绘`，因此有一个定向法则：**回流必定引发重绘，重绘不一定引发回流**。

#### 合成图层

将绘制生成的图层逐张合并并显示在屏幕上。

上述几个步骤并非一次性顺序完成，若改动`DOM/CSSOM`，上述过程会被重新执行，实际上`CSS`与`JS`往往会多次改动`DOM/CSSOM`。简而言之，用户的交互操作引发了网页的重渲染。



### 兼容性

又称网页兼容性，指网页在各种浏览器中的显示效果可能不同而产生浏览器与网页间的兼容问题。

一个专门为开发者定制，可查询`W3C标准`在各种浏览器中兼容性的网站[Caniuse](https://caniuse.com/)，可快速了解`W3C标准`在各个浏览器中的表现。

产生浏览器间的兼容问题，正是渲染引擎在渲染网页时因为某些差异而导致的。在网页的设计与开发中，做好浏览器兼容才能让网页在不同浏览器中都能显示正常。

以下是`CSS兼容性`的三种解决方案，相对处理`JS兼容性`来说更简单。

#### 磨平浏览器默认样式

每个浏览器的`CSS默认样式`不尽相同，最简单最有效的方式就是对其默认样式初始化。

以下默认样式初始化的代码简单暴力但不明确，`*`通配符有执行性能问题。

```css
* {
  margin: 0;
  padding: 0;
}
```

推荐两种磨平浏览器默认样式的方式：

* [normalize.css](https://github.com/necolas/normalize.css/blob/master/normalize.css)：懒人必备的浏览器默认样式
* [reset.css](https://github.com/JowayYoung/idea-css/blob/master/css/reset.css)：作者自定义的默认样式，大家也可以自行为所有应用撰写一份默认样式

在应用入口文件的其他`css文件`前导入默认样式文件。

```javascript
import "path/to/normalize.css";
// or
import "path/to/reset.css";
```

#### 加入浏览器私有属性

通常编写`CSS`都会在一些`CSS3`属性前加入`-webkit-`、`-moz-`、`-ms-`或`-o-`，这些就是浏览器私有属性。

出现这些私有属性，是因为制定`CSS标准`的`W3C组织`动作很慢，量产一个属性需走一个很严格很复杂的流程。一个成熟且被大众肯定的属性，浏览器厂商会加大其支持力度，但为了避免日后`W3C组织`公布标准属性时有所变更，就加入一个本厂商的私有属性提前支持该属性，待`W3C组织`公布该标准属性后，再让新版浏览器支持该标准属性。

对于编写私有属性的顺序需特别注意：**兼容性写法放到前面，标准性写法放到最后**。在浏览器解析`CSS`时，若标准属性无法使用则使用当前浏览器相应私有属性。

```css
/* Chrome、Safari、New Opera、New Edge */
-webkit-transform: translate(10px, 10px);
/* Firefox */
-moz-transform: translate(10px, 10px);
/* IExplorer、Old Edge */
-ms-transform:translate(10px, 10px);
/* Old Opera */
-o-transform: translate(10px, 10px);
/* 标准 */
transform: translate(10px, 10px);
```

当然不是所有`CSS3属性`都需补齐`-webkit-`、`-moz-`、`-ms-`或`-o-`。真正的`transform`私有属性只有`-webkit-`与`-ms-`。

在使用`webpack`打包代码时，可接入[postcss-loader](https://github.com/postcss/postcss-loader)与[postcss-preset-env](https://github.com/csstools/postcss-preset-env)，`postcss-preset-env`内置了`autoprefixer`，会根据`Caniuse`提供的数据对代码中的`CSS3属性`批量加入私有属性。

自动化工具的好处就是为了解决一些重复而无趣的工作。

#### CSS Hack

指针对不同浏览器编写不同`CSS`，让它能够同时兼容不同浏览器，在不同浏览器中渲染想要的效果。也可反过来利用`CSS Hack`为不同版本的浏览器定制不同效果。

一些老旧网页的`HTML文件`或`CSS文件`中可能会看到以下代码，这就是`CSS Hack`。

```html
<head>
  <!--[if IE]>
  <style>
    .elem {
      background-color: #f66;
    }
  </style>
	<![endif]-->
</head>
```

```css
.elem {
  background-color: #f66; /* IE 8+ */
  *background-color: #f66; /* IE 7 */
  _background-color: #f66; /* IE 6 */
}
```

现在很多同学都不会遇到这种写法，毕竟很多公司的网站都放弃了`IE 8`以下的兼容，这些痕迹都已成为历史，有一个基本了解即可。

综上，结合`磨平浏览器默认样式`与`加入浏览器私有属性`这两种方式完成浏览器兼容性的处理即可。

> IE兼容性
>
> IE的垄断性使得Trident内核在十多年中一家独大，在很长时间内都无更新Trident内核，导致其曾经与`W3C`标准完全脱节，大量安全隐患无法得到解决。`jQuery`源码中包括大量`IE兼容代码`，所以在移动端中使用费力不讨好，后面才出现`zepto`库代替`jQuery`在移动端中的使用，因为删除了所有`IE兼容代码`，体积很少。

很多国产浏览器都是基于开源内核架构`Chromium`二次开发，可认为是`Chrome`外面又包了一层外壳。另外有些国产浏览器打着双内核的旗号，在`Blink内核`的基础上又增加一个`Trident内核`。`Blink内核`对应浏览器的极速模式，可访问一些较现代化与技术超前的网站，比如官方网站、游戏网站、视觉网站、可视化网站等；`Trident内核`对应浏览器的兼容模式，可访问一些久经不衰的网站，比如政府网站、政务网站、金融网站等。



